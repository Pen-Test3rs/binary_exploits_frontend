import { User } from '../models/user';
import { LoginData } from '../models/loginData';
import { RegisterData } from '../models/registerData';
import axiosInstance from '../utils/axiosInterceptors';
import { Token } from '../models/token';
import { apiUrls } from '../utils/apiUrls';
import { AxiosError, AxiosResponse } from 'axios';
import { store } from '../context/store';
import { updateTokens } from '../context/userReducer';

const responseBody = (response: AxiosResponse) => response.data;

const me = async (token: string): Promise<User> => {
    return axiosInstance
        .get(apiUrls.ME, {
            headers: { Authorization: `Bearer ${token}` }
        })
        .then(responseBody);
};

const login = async (loginData: LoginData): Promise<User> => {
    const token = await getToken(loginData.username, loginData.password);
    const user = await me(token.access);
    user.token = token;

    return user;
};

const getToken = async (username: string, password: string): Promise<Token> => {
    return axiosInstance
        .post(apiUrls.TOKEN, {
            username: username,
            password: password
        })
        .then(responseBody);
};

const register = async (registerData: RegisterData): Promise<User> => {
    const user = await axiosInstance.post(apiUrls.REGISTER, registerData).then(responseBody);
    user.token = await getToken(user.username, registerData.password);

    return user;
};

const getAccessToken = () => {
    return store.getState().userReducer.token?.access;
};

const getRefreshToken = () => {
    return store.getState().userReducer.token?.refresh;
};

const getNewAccessToken = async (refreshToken: string): Promise<Token> => {
    return axiosInstance
        .post(apiUrls.REFRESH_TOKEN, {
            refresh: refreshToken
        })
        .then(responseBody);
};

const refreshUserToken = async (err: AxiosError) => {
    const config = err.config;
    const refreshToken = getRefreshToken();
    if (refreshToken == null) {
        return Promise.reject(err);
    }

    const token = await getNewAccessToken(refreshToken);
    store.dispatch(updateTokens(token));
    config.headers.Authorization = `Bearer ${token.access}`; // inject new token to old request
    return axiosInstance.request(config);
};

export const authService = {
    login,
    register,
    getAccessToken,
    refreshUserToken
};

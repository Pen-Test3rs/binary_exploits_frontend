import RatingCard from './ratingCard';
import CardLineChart from '../charts/cardLineChart';
import useAxiosEffect from '../generic/useAxiosEffect';
import { dashboardService } from '../../services/dashboardService';
import { prepareChartData } from '../charts/prepareChartData';
import { ComponentStateHandler, getAggregatedState } from '../generic/componentStateHandler';
import LiveActivityComponent from './liveActivityComponent';
import { FaChartArea, FaRocket, FaTrophy } from 'react-icons/fa';
import { LiveActivity, Rating } from '../../models/dashboard';
import { useAppSelector } from '../../context/hooks';
import { currentUserData, isLoggedIn } from '../../context/userReducer';
import { Link } from 'react-router-dom';
import SubmitButton from '../shared/form/submitButton';
import CustomHeader from '../generic/CustomHeader';
import React from 'react';

const DashboardComponent = () => {
    const dashboardState = useAxiosEffect<[Rating[], LiveActivity[]]>(
        getAggregatedState(dashboardService.getRating, dashboardService.getLiveActivity),
        []
    );

    const ratingData = prepareChartData(dashboardState?.data?.[0] || []);
    const liveActivityData = dashboardState?.data?.[1] || [];

    const logged = useAppSelector(isLoggedIn);
    const user = useAppSelector(currentUserData);
    const noSolutions = user.solved === 0;

    return (
        <ComponentStateHandler state={dashboardState}>
            <div className="flex flex-col lg:pt-0 w-full mx-auto px-4 xl:w-8/12 items-stretch lg:max-w-6xl">
                {logged && noSolutions && (
                    <div className={'bg-white rounded-lg flex flex-col items-stretch shadow my-2'}>
                        <CustomHeader title={'Witamy w serwisie!'} Icon={FaRocket} />
                        <div className="w-full p-3 text-sm text-center flex-col grid gap-2">
                            <div>Cieszymy się, że dołączyłeś do platformy treningowej!</div>
                            <div className="">
                                Zdobywaj punky rozwiązując przygotowane{' '}
                                <strong>
                                    <Link to="/tasks">zadania</Link>
                                </strong>
                                . Pomocne będą materiały zgomadzone w{' '}
                                <strong>
                                    <Link to="/tasks">bazie wiedzy</Link>
                                </strong>
                                , wprowadzające Cię od podstaw w świat eksploitacji binarnej. Kliknij w przycisk
                                poniżej, aby dowiedzieć się, jak używać serwisu.
                            </div>
                            <div className="m-auto">
                                <Link to="/articles/15">
                                    <SubmitButton loading={false} text="Wprowadzenie do platformy" loadingText={''} />
                                </Link>
                            </div>
                        </div>
                    </div>
                )}
                <div className={'bg-white rounded-lg flex flex-col self-stretch shadow my-2'}>
                    <CustomHeader title={'Ranking'} Icon={FaChartArea} />
                    <div className="w-full">
                        <CardLineChart ratingData={ratingData} displayLegend={true} className="h-96 rounded-b-lg" />
                    </div>
                </div>
                <div className="flex flex-col md:flex-row md:gap-4 w-full lg:w-auto">
                    <div
                        className={
                            'bg-white rounded-lg flex flex-col items-stretch shadow my-2 flex-grow md:self-start'
                        }
                    >
                        <CustomHeader title={'Top użytkownicy'} Icon={FaTrophy} />
                        <div className="flex flex-col max-w-none w-full rounded-b-lg overflow-hidden">
                            <RatingCard ratingData={ratingData} />
                        </div>
                    </div>
                    <div className="my-2 flex-grow">
                        <LiveActivityComponent liveActivity={liveActivityData} />
                    </div>
                </div>
            </div>
        </ComponentStateHandler>
    );
};

export default DashboardComponent;
